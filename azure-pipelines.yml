trigger:
- none

pool:
  vmImage: windows-latest

# Set the BuildNumber = Format 1.0.yyyyMMdd.r
name: '1.0.$(Date:yyyyMMdd).$(rev:r)'

variables:
  SolutionNameMain: 'ROMTS-GSRST'
  SolutionNameFlows: 'ROMTS-GSRST.Flows'
  RuleSetId: '0ad12346-e108-40b8-a956-9a8f95ea18c9'

steps:
- checkout: self
  persistCredentials: true
  clean: true

- task: PowerPlatformToolInstaller@0
  displayName: 'Install Power Platform Build Tools'
  inputs:
    DefaultVersion: true

# Ensure output folders exist so publishing results never errors on missing path
- powershell: |
    New-Item -ItemType Directory -Force -Path "$(Build.ArtifactStagingDirectory)\SolutionChecker\Main" | Out-Null
    New-Item -ItemType Directory -Force -Path "$(Build.ArtifactStagingDirectory)\SolutionChecker\Flows" | Out-Null
  displayName: 'Create Solution Checker output folders'

# --- Versioning (do NOT block the rest of the pipeline if PP-BT v0 crashes) ---
- task: PowerPlatformSetSolutionVersion@0
  displayName: 'Update Solution Version (Main)'
  continueOnError: true
  inputs:
    authenticationType: 'PowerPlatformSPN'
    PowerPlatformSPN: 'ROMTS-GSRST DEV'
    SolutionName: '$(SolutionNameMain)'
    SolutionVersionNumber: '$(Build.BuildNumber)'

- task: PowerPlatformSetSolutionVersion@0
  displayName: 'Update Solution Version (Flows)'
  continueOnError: true
  inputs:
    authenticationType: 'PowerPlatformSPN'
    PowerPlatformSPN: 'ROMTS-GSRST DEV'
    SolutionName: '$(SolutionNameFlows)'
    SolutionVersionNumber: '$(Build.BuildNumber)'

- task: PowerPlatformPublishCustomizations@0
  displayName: 'Publish All Customizations (Dev)'
  continueOnError: true
  inputs:
    authenticationType: 'PowerPlatformSPN'
    PowerPlatformSPN: 'ROMTS-GSRST DEV'

# --- Export (force export even if versioning/publish customizations had issues) ---
- task: MSCRMToolInstaller@12
  displayName: 'Install MSCRM Tools'
  condition: always()
  inputs:
    nugetFeed: 'official'
    psFeed: 'official'

- task: MSCRMExportSolution@12
  displayName: 'Export Unmanaged (Main)'
  condition: always()
  inputs:
    crmConnectionString: '$(ConnectionStringDev)'
    solutionName: '$(SolutionNameMain)'
    exportManaged: false
    exportUnmanaged: true
    outputPath: '$(Build.ArtifactStagingDirectory)'
    crmConnectionTimeout: '1960'
    useAsyncMode: true
    asyncWaitTimeout: '1900'

- task: MSCRMExportSolution@12
  displayName: 'Export Unmanaged (Flows)'
  condition: always()
  inputs:
    crmConnectionString: '$(ConnectionStringDev)'
    solutionName: '$(SolutionNameFlows)'
    exportManaged: false
    exportUnmanaged: true
    outputPath: '$(Build.ArtifactStagingDirectory)'
    crmConnectionTimeout: '1960'
    useAsyncMode: true
    asyncWaitTimeout: '1900'

# --- Sanity check (always show what's in staging) ---
- powershell: |
    Write-Host "Artifact staging dir: $(Build.ArtifactStagingDirectory)"
    Get-ChildItem "$(Build.ArtifactStagingDirectory)" | Format-Table -AutoSize
    Write-Host "ZIPs:"
    Get-ChildItem "$(Build.ArtifactStagingDirectory)" -Filter *.zip -ErrorAction SilentlyContinue | Format-Table -AutoSize
  displayName: 'List staging contents'
  condition: always()

# --- Detect whether exported zips exist (set variables for later conditions) ---
- powershell: |
    $main = "$(Build.ArtifactStagingDirectory)\$(SolutionNameMain).zip"
    $flows = "$(Build.ArtifactStagingDirectory)\$(SolutionNameFlows).zip"

    if (Test-Path $main) {
      Write-Host "Found MAIN zip: $main"
      Write-Host "##vso[task.setvariable variable=MainZipExists]true"
    } else {
      Write-Host "Missing MAIN zip: $main"
      Write-Host "##vso[task.setvariable variable=MainZipExists]false"
    }

    if (Test-Path $flows) {
      Write-Host "Found FLOWS zip: $flows"
      Write-Host "##vso[task.setvariable variable=FlowsZipExists]true"
    } else {
      Write-Host "Missing FLOWS zip: $flows"
      Write-Host "##vso[task.setvariable variable=FlowsZipExists]false"
    }
  displayName: 'Detect exported zip presence'
  condition: always()

# --- Solution Checker (only if the expected zip exists) ---
- task: PowerPlatformChecker@0
  displayName: 'Run Solution Checker (Main)'
  condition: and(always(), eq(variables['MainZipExists'], 'true'))
  continueOnError: true
  inputs:
    authenticationType: 'PowerPlatformSPN'
    PowerPlatformSPN: 'ROMTS-GSRST DEV'
    FilesToAnalyze: '$(Build.ArtifactStagingDirectory)\$(SolutionNameMain).zip'
    RuleSet: '$(RuleSetId)'
    SaveResults: true
    OutputPath: '$(Build.ArtifactStagingDirectory)\SolutionChecker\Main'
    ErrorLevel: 'Informational'
    ErrorThreshold: 6000

- task: PowerPlatformChecker@0
  displayName: 'Run Solution Checker (Flows)'
  condition: and(always(), eq(variables['FlowsZipExists'], 'true'))
  continueOnError: true
  inputs:
    authenticationType: 'PowerPlatformSPN'
    PowerPlatformSPN: 'ROMTS-GSRST DEV'
    FilesToAnalyze: '$(Build.ArtifactStagingDirectory)\$(SolutionNameFlows).zip'
    RuleSet: '$(RuleSetId)'
    SaveResults: true
    OutputPath: '$(Build.ArtifactStagingDirectory)\SolutionChecker\Flows'
    ErrorLevel: 'Informational'
    ErrorThreshold: 6000

- task: PublishPipelineArtifact@1
  displayName: 'Publish Solution Checker Results'
  condition: always()
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)\SolutionChecker'
    artifact: 'SolutionCheckerResults'
    publishLocation: 'pipeline'

# --- Publish zips for Release to consume ---
- task: PublishPipelineArtifact@1
  displayName: 'Publish Artifacts'
  condition: always()
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)'
    artifact: 'drop'
    publishLocation: 'pipeline'

# --- Unpack both (only if zip exists) ---
- task: PowerPlatformUnpackSolution@0
  displayName: 'Unpack Unmanaged (Main)'
  condition: and(always(), eq(variables['MainZipExists'], 'true'))
  inputs:
    SolutionInputFile: '$(Build.ArtifactStagingDirectory)\$(SolutionNameMain).zip'
    SolutionTargetFolder: '$(Build.SourcesDirectory)\$(SolutionNameMain)'

- task: PowerPlatformUnpackSolution@0
  displayName: 'Unpack Unmanaged (Flows)'
  condition: and(always(), eq(variables['FlowsZipExists'], 'true'))
  inputs:
    SolutionInputFile: '$(Build.ArtifactStagingDirectory)\$(SolutionNameFlows).zip'
    SolutionTargetFolder: '$(Build.SourcesDirectory)\$(SolutionNameFlows)'

# --- Commit + push ---
- task: PowerShell@2
  displayName: 'Commit Unpacked Solutions to Source Control'
  condition: always()
  inputs:
    targetType: 'inline'
    script: |
      git config user.email "nepasrepondre-noreply@tc.gc.ca"
      git config user.name "tc-buildbot"

      git checkout main

      git add --all

      $status = git status --porcelain
      if ([string]::IsNullOrWhiteSpace($status)) {
        Write-Host "No changes to commit."
        exit 0
      }

      $msg = "Update MAIN+FLOWS - $(Build.BuildNumber)"
      git commit -m "$msg"

      git -c http.extraheader="AUTHORIZATION: bearer $(System.AccessToken)" push origin main
