trigger:
- none

pool:
  vmImage: windows-latest

name: '1.0.$(Date:yyyyMMdd).$(rev:r)'

variables:
  SolutionNameMain: 'ROMTS-GSRST'
  SolutionNameFlows: 'ROMTS-GSRST.Flows'
  RuleSetId: '0ad12346-e108-40b8-a956-9a8f95ea18c9'
  PPServiceConnection: 'ROMTS-GSRST DEV'

steps:
- checkout: self
  persistCredentials: true
  clean: true
  fetchDepth: 0

# --- PP Build Tools v2 installer ---
- task: microsoft-IsvExpTools.PowerPlatform-BuildTools.tool-installer.PowerPlatformToolInstaller@2
  displayName: 'Power Platform Tool Installer (v2)'
  inputs:
    AddToolsToPath: true

# Fail fast if the service connection/auth is broken
- task: microsoft-IsvExpTools.PowerPlatform-BuildTools.whoami.PowerPlatformWhoAmi@2
  displayName: 'Power Platform WhoAmI (verify connection)'
  inputs:
    authenticationType: PowerPlatformSPN
    PowerPlatformSPN: '$(PPServiceConnection)'

# Ensure checker output folders exist
- powershell: |
    New-Item -ItemType Directory -Force -Path "$(Build.ArtifactStagingDirectory)\SolutionChecker\Main" | Out-Null
    New-Item -ItemType Directory -Force -Path "$(Build.ArtifactStagingDirectory)\SolutionChecker\Flows" | Out-Null
  displayName: 'Create Solution Checker output folders'

# --- Versioning (v2) ---
# Keep these NON-blocking, but don't run them if WhoAmI failed.
- task: microsoft-IsvExpTools.PowerPlatform-BuildTools.set-solution-version.PowerPlatformSetSolutionVersion@2
  displayName: 'Update Solution Version (Main)'
  condition: succeeded()
  continueOnError: true
  inputs:
    authenticationType: PowerPlatformSPN
    PowerPlatformSPN: '$(PPServiceConnection)'
    SolutionName: '$(SolutionNameMain)'
    SolutionVersionNumber: '$(Build.BuildNumber)'

- task: microsoft-IsvExpTools.PowerPlatform-BuildTools.set-solution-version.PowerPlatformSetSolutionVersion@2
  displayName: 'Update Solution Version (Flows)'
  condition: succeeded()
  continueOnError: true
  inputs:
    authenticationType: PowerPlatformSPN
    PowerPlatformSPN: '$(PPServiceConnection)'
    SolutionName: '$(SolutionNameFlows)'
    SolutionVersionNumber: '$(Build.BuildNumber)'

# --- Publish customizations (v2) ---
- task: microsoft-IsvExpTools.PowerPlatform-BuildTools.publish-customizations.PowerPlatformPublishCustomizations@2
  displayName: 'Publish All Customizations (Dev)'
  condition: succeeded()
  continueOnError: true
  retryCountOnTaskFailure: 3
  inputs:
    authenticationType: PowerPlatformSPN
    PowerPlatformSPN: '$(PPServiceConnection)'

# --- Export unmanaged (v2) ---
- task: microsoft-IsvExpTools.PowerPlatform-BuildTools.export-solution.PowerPlatformExportSolution@2
  displayName: 'Export Unmanaged (Main)'
  condition: succeeded()
  retryCountOnTaskFailure: 3
  inputs:
    authenticationType: PowerPlatformSPN
    PowerPlatformSPN: '$(PPServiceConnection)'
    SolutionName: '$(SolutionNameMain)'
    SolutionOutputFile: '$(Build.ArtifactStagingDirectory)\$(SolutionNameMain).zip'
    Managed: false
    MaxAsyncWaitTime: 120

- task: microsoft-IsvExpTools.PowerPlatform-BuildTools.export-solution.PowerPlatformExportSolution@2
  displayName: 'Export Unmanaged (Flows)'
  condition: succeeded()
  retryCountOnTaskFailure: 3
  inputs:
    authenticationType: PowerPlatformSPN
    PowerPlatformSPN: '$(PPServiceConnection)'
    SolutionName: '$(SolutionNameFlows)'
    SolutionOutputFile: '$(Build.ArtifactStagingDirectory)\$(SolutionNameFlows).zip'
    Managed: false
    MaxAsyncWaitTime: 120

# --- Verify ZIPs exist (this gates unpack/checker) ---
- powershell: |
    $main = "$(Build.ArtifactStagingDirectory)\$(SolutionNameMain).zip"
    $flows = "$(Build.ArtifactStagingDirectory)\$(SolutionNameFlows).zip"

    $missing = @()
    if (-not (Test-Path $main)) { $missing += $main }
    if (-not (Test-Path $flows)) { $missing += $flows }

    Write-Host "Staging directory:"
    Get-ChildItem "$(Build.ArtifactStagingDirectory)" | Format-Table -AutoSize

    if ($missing.Count -gt 0) {
      Write-Error ("Missing expected solution ZIP(s):`n" + ($missing -join "`n"))
    } else {
      Write-Host "Both ZIPs are present."
    }
  displayName: 'Verify exported ZIPs exist'
  condition: succeeded()

# --- Checker (v2) on exported zips ---
- task: microsoft-IsvExpTools.PowerPlatform-BuildTools.checker.PowerPlatformChecker@2
  displayName: 'Run Solution Checker (Main)'
  condition: succeeded()
  continueOnError: true
  inputs:
    PowerPlatformSPN: '$(PPServiceConnection)'
    FilesToAnalyze: '$(Build.ArtifactStagingDirectory)\$(SolutionNameMain).zip'
    RuleSet: '$(RuleSetId)'
    SaveResults: true
    OutputPath: '$(Build.ArtifactStagingDirectory)\SolutionChecker\Main'
    ErrorLevel: 'Informational'
    ErrorThreshold: 6000

- task: microsoft-IsvExpTools.PowerPlatform-BuildTools.checker.PowerPlatformChecker@2
  displayName: 'Run Solution Checker (Flows)'
  condition: succeeded()
  continueOnError: true
  inputs:
    PowerPlatformSPN: '$(PPServiceConnection)'
    FilesToAnalyze: '$(Build.ArtifactStagingDirectory)\$(SolutionNameFlows).zip'
    RuleSet: '$(RuleSetId)'
    SaveResults: true
    OutputPath: '$(Build.ArtifactStagingDirectory)\SolutionChecker\Flows'
    ErrorLevel: 'Informational'
    ErrorThreshold: 6000

- task: PublishPipelineArtifact@1
  displayName: 'Publish Solution Checker Results'
  condition: always()
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)\SolutionChecker'
    artifact: 'SolutionCheckerResults'
    publishLocation: 'pipeline'

# --- Publish exported zips as artifact for Release ---
- task: PublishPipelineArtifact@1
  displayName: 'Publish Artifacts (drop)'
  condition: always()
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)'
    artifact: 'drop'
    publishLocation: 'pipeline'

# --- Unpack both (v2) ---
- task: microsoft-IsvExpTools.PowerPlatform-BuildTools.unpack-solution.PowerPlatformUnpackSolution@2
  displayName: 'Unpack Unmanaged (Main)'
  condition: succeeded()
  inputs:
    SolutionInputFile: '$(Build.ArtifactStagingDirectory)\$(SolutionNameMain).zip'
    SolutionTargetFolder: '$(Build.SourcesDirectory)\$(SolutionNameMain)'
    SolutionType: 'Unmanaged'

- task: microsoft-IsvExpTools.PowerPlatform-BuildTools.unpack-solution.PowerPlatformUnpackSolution@2
  displayName: 'Unpack Unmanaged (Flows)'
  condition: succeeded()
  inputs:
    SolutionInputFile: '$(Build.ArtifactStagingDirectory)\$(SolutionNameFlows).zip'
    SolutionTargetFolder: '$(Build.SourcesDirectory)\$(SolutionNameFlows)'
    SolutionType: 'Unmanaged'

# --- Commit + push back to main ---
# IMPORTANT: bearer token requires "Allow scripts to access OAuth token" enabled.
- task: PowerShell@2
  displayName: 'Commit Unpacked Solutions to Source Control'
  condition: succeeded()
  inputs:
    targetType: 'inline'
    script: |
      git config user.email "nepasrepondre-noreply@tc.gc.ca"
      git config user.name "tc-buildbot"

      git fetch origin main
      git checkout -B main origin/main

      git add --all

      $status = git status --porcelain
      if ([string]::IsNullOrWhiteSpace($status)) {
        Write-Host "No changes to commit."
        exit 0
      }

      $msg = "chore: sync MAIN+FLOWS $(Build.BuildNumber)"
      git commit -m "$msg"

      git -c http.extraheader="AUTHORIZATION: bearer $(System.AccessToken)" push origin HEAD:main
